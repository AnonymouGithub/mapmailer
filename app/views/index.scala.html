@(groups: List[String], location: models.Location, placeMarker: Boolean, markerPopup: Option[String] = None)
@main("MapMailer") {
<script type="text/javascript" language="javascript" src="//code.jquery.com/jquery.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/jquery.clipboard.js"></script>
<script type="text/javascript" language="javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>

<script type="text/javascript" language="javascript" src="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/leaflet.draw.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/leaflet.awesome-markers.js"></script>
<script type="text/javascript">
    function init() {
        jQuery.extend({
            postJSON: function (url, data, callback) {
                return jQuery.ajax({
                    type: "POST",
                    url: url,
                    data: JSON.stringify(data),
                    success: callback,
                    dataType: "json",
                    contentType: "application/json",
                    processData: false
                });
            }
        });

        L.Map = L.Map.extend({
            openPopup: function(popup) {
                if (!(popup instanceof L.Popup)) {
                    var content = popup;
                    popup = new L.Popup(options)
                        .setLatLng(latlng)
                        .setContent(content);
                    }
                popup._isOpen = true;

                this._popup = popup;
                return this.addLayer(popup);
            }
        });

        @for(group <- groups) {
        var @(group)Group = new L.LayerGroup();
        }

        var mapTiles = L.tileLayer('http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        });

        var map = new L.Map('map', {
            center: new L.LatLng(@location.latitude, @location.longitude),
            zoom: 7,
            layers: [mapTiles, @for(group <- groups) { @(group)Group, }]
        });

        var overlays = {
            @for(group <- groups) { "@(group)":@(group)Group, }
        };
        L.control.layers({}, overlays).addTo(map);

        var markers = [];

        @if(placeMarker) {
            map.setZoom(12);

            var subjectIcon = L.AwesomeMarkers.icon({icon : 'fa-bullseye', markerColor : 'red', prefix: 'fa'});
            var marker = L.marker([@location.latitude, @location.longitude], {icon: subjectIcon})
            markers.push(marker.getLatLng());
            marker.addTo(map).bindPopup("@markerPopup.getOrElse("")").openPopup();
        }

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: {
                    showArea: true,
                    allowIntersection: false,
                    drawError: {
                        color: '#e1e100',
                        message: '<strong>Nein!<strong> You can\'t draw an intersecting polygon.'
                    },
                    shapeOptions: {
                        color: '#a94442'
                    },
                    metric: false
                },
                rectangle: false,
                circle: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        map.on('draw:created', function (e) {
            var type = e.layerType, layer = e.layer;

            if (type === 'polygon') {
                $.postJSON('/search', layer.toGeoJSON(), function(data) {
                    $.each(data, function(i, party) {
                        if (party.organisation) {
                            var organisationIcon = L.AwesomeMarkers.icon({icon : 'fa-building-o', markerColor : 'cadetblue', prefix: 'fa'});
                            var marker = L.marker([party.location.latitude, party.location.longitude], {icon: organisationIcon})
                            if ($.grep(markers, function(e){ return e.equals(marker.getLatLng()); }) == 0) {
                                markers.push(marker.getLatLng());
                                marker.addTo(map).bindPopup(party.name + " (" + party.postcode + ")");
                            }
                        }
                        else {
                            var personIcon = L.AwesomeMarkers.icon({icon : 'fa-user', markerColor : 'green', prefix: 'fa'});
                            var marker = L.marker([party.location.latitude, party.location.longitude], {icon: personIcon})
                            if ($.grep(markers, function(e){ return e.equals(marker.getLatLng()); }) == 0) {
                                markers.push(marker.getLatLng());
                                marker.addTo(map).bindPopup(party.name + " (" + party.postcode + ")");
                            }
                        }
                    });

                    layer.bindPopup('Found ' + data.length + ' parties. <a href="#" class="copy button fa fa-clipboard">copy people</a> copy organisations');

                    $('a.copy').clipboard({
                        path: '/assets/flashes/jquery.clipboard.swf'
                    });

                    drawnItems.addLayer(layer);
                }, 'json');
            }
        });

        new L.Control.Scale({maxWidth: 1200, metric: false}).addTo(map);
        new L.Control.Scale({maxWidth: 600, metric: false}).addTo(map);
        new L.Control.Scale({maxWidth: 300, metric: false}).addTo(map);
    }
</script>
<body onLoad="javascript:init();">
<div id="map"></div>
</body>
}
