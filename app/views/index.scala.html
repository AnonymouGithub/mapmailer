@(groups: List[String], center: models.Location)
@main("MapMailer") {
<script type="text/javascript" language="javascript" src="//code.jquery.com/jquery.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/jquery.clipboard.js"></script>
<script type="text/javascript" language="javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
<script type="text/javascript" language="javascript" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
<script type="text/javascript" language="javascript" src="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/purl.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/leaflet.draw.js"></script>
<script type="text/javascript" language="javascript" src="/assets/javascripts/leaflet.awesome-markers.js"></script>
<script type="text/javascript">
    function init() {
        jQuery.extend({
            postJSON: function (url, data, callback) {
                return jQuery.ajax({
                    type: "POST",
                    url: url,
                    data: JSON.stringify(data),
                    success: callback,
                    dataType: "json",
                    contentType: "application/json",
                    processData: false
                });
            }
        });

        Handlebars.registerHelper('join', function(items, block) {
            var delimiter = block.hash.delimiter || ", ",
            start = start = block.hash.start || 0,
            len = items ? items.length : 0,
            end = block.hash.end || len,
            out = "";

            if(end > len) end = len;

            if ('function' === typeof block) {
                for (i = start; i < end; i++) {
                    if (i > start) out += delimiter;
                    if('string' === typeof items[i]) out += items[i];
                    else out += block(items[i]);
                }
                return out;
            } else {
                return [].concat(items).slice(start, end).join(delimiter);
            }
        });

        L.Circle = L.Circle.extend({
    	    toGeoJSON: function () {
                return L.GeoJSON.getFeature(this, {
                    type: 'Circle',
                    coordinates: L.GeoJSON.latLngToCoords(this.getLatLng()),
                    radius: this.getRadius()
                });
            }
        });

        @for(group <- groups) {
        var @(group)Group = new L.LayerGroup();
        }

        var mapTiles = L.tileLayer('http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        });

        var map = new L.Map('map', {
            center: new L.LatLng(@center.latitude, @center.longitude),
            zoom: 7,
            layers: [mapTiles]
        });

        var overlays = {
            @for(group <- groups) { "@(group)":@(group)Group, }
        };
        L.control.layers({}, overlays).addTo(map);

        var popupOptions = {minWidth: 260, maxWidth: 300};
        var markers = [];

        var layerTemplate = Handlebars.compile($("#area-popup").html());
        var organisationPopupTemplate = Handlebars.compile($("#organisation-popup").html());
        var personPopupTemplate = Handlebars.compile($("#person-popup").html());

        var handle = function(party) {
            if (party.organisation) {
                var organisationIcon = L.AwesomeMarkers.icon({icon : 'fa-building-o', markerColor : 'cadetblue', prefix: 'fa'});
                var marker = L.marker([party.location.latitude, party.location.longitude], {icon: organisationIcon});
                if ($.grep(markers, function(e){ return e.equals(marker.getLatLng()); }) == 0) {
                    markers.push(marker.getLatLng());
                    marker.bindPopup(L.popup(popupOptions).setContent(organisationPopupTemplate(party)));
                    $.each(party.groups, function(i, group) { eval("marker.addTo(" + group + "Group);"); });
                }
                return marker;
            }
            else {
                var personIcon = L.AwesomeMarkers.icon({icon : 'fa-user', markerColor : 'green', prefix: 'fa'});
                var marker = L.marker([party.location.latitude, party.location.longitude], {icon: personIcon});
                if ($.grep(markers, function(e){ return e.equals(marker.getLatLng()); }) == 0) {
                    markers.push(marker.getLatLng());
                    marker.bindPopup(L.popup(popupOptions).setContent(personPopupTemplate(party)));
                    $.each(party.groups, function(i, group) { eval("marker.addTo(" + group + "Group);"); });
                }
                return marker;
            }
        };

        if ($.url().param('partyId')) {
            $.getJSON('/party/' + $.url().param('partyId'), function(party) {
                map.setZoom(13);
                map.panTo(new L.LatLng(party.location.latitude, party.location.longitude));
                var icon = L.AwesomeMarkers.icon({icon : 'fa-bullseye', markerColor : 'red', prefix: 'fa'});
                handle(party).setIcon(icon).addTo(map).openPopup();
            })
            .fail(function () {
                alert("Can't find party with id " + $.url().param('partyId'))
            });
        }

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: {
                    showArea: true,
                    allowIntersection: false,
                    drawError: {
                        color: '#e1e100',
                        message: '<strong>Nein!<strong> You can\'t draw an intersecting polygon.'
                    },
                    shapeOptions: {
                        color: '#2F4F4F'
                    },
                    metric: false
                },
                rectangle: false,
                circle: {
                    shapeOptions: {
                        color: '#2F4F4F'
                    }
                },
                marker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        map.on('draw:created', function (e) {
            var type = e.layerType, layer = e.layer;

            if (type === 'polygon' || type === 'circle') {
                $.postJSON('/party/search', layer.toGeoJSON(), function(data) {
                    $.each(data, function(i, party) {
                        handle(party);
                    });

                    layer.bindPopup(L.popup(popupOptions).setContent(layerTemplate(data)));

                    $('a.copy').clipboard({
                        path: '/assets/flashes/jquery.clipboard.swf',

                        copy: function() {
                            var emailAddresses = "";
                            $.each (data, function (i, party) {
                                emailAddresses += party.name;
                            });
                            return emailAddresses;
                        }
                    });

                    drawnItems.addLayer(layer);
                }, 'json');
            }
        });

        new L.Control.Scale({maxWidth: 1200, metric: false}).addTo(map);
        new L.Control.Scale({maxWidth: 600, metric: false}).addTo(map);
        new L.Control.Scale({maxWidth: 300, metric: false}).addTo(map);
    }
</script>

<script id="person-popup" type="text/x-handlebars-template">
    <div class="row">
        <div class="col-8">
            <strong><span title="{{postcode}}">{{ name }}</span></strong><br/>
            {{ join groups }}
        </div>
        <div class="col-4 text-right">
            <div class="btn-group">
                <a href="@play.Play.application().configuration().getString("crm.url")/{{ partyId }}" title="Capsule CRM" target="_blank" class="btn btn-default btn-sm"><i class="fa fa-gear fa-lg"></i></a>
                <a href="mailto:{{ emailAddress }}?bcc=@play.Play.application().configuration().getString("crm.bcc")" title="{{ emailAddress }}" target="_blank" class="btn btn-default btn-sm"><i class="fa fa-envelope-o fa-lg"></i></a>
            </div>
        </div>
    </div>
</script>

<script id="organisation-popup" type="text/x-handlebars-template">
    <div class="row">
        <div class="col-7 col-md-7">
            <strong><span title="{{postcode}}">{{ name }}</span></strong>
        </div>
        <div class="col-5 col-lg-5 text-right">
            <div class="btn-group">
                <a href="@play.Play.application().configuration().getString("crm.url")/{{ partyId }}" title="Capsule CRM" target="_blank" class="btn btn-default btn-sm"><i class="fa fa-gear fa-lg"></i></a>
                <a href="mailto:{{ emailAddress }}?bcc=@play.Play.application().configuration().getString("crm.bcc")" title="{{ emailAddress }}" target="_blank" class="btn btn-default btn-sm"><i class="fa fa-envelope-o fa-lg"></i></a>
                <a href="{{ website }}" target="_blank" title="{{ website }}" class="btn btn-default btn-sm"><i class="fa fa-external-link fa-lg"></i></a>
            </div>
        </div>
    </div>
</script>

<script id="area-popup" type="text/x-handlebars-template">
    Found {{ this.length }} parties. <a href="#" class="copy"><i class="fa fa-clipboard"></i>test</a> copy organisations
</script>

<body onLoad="javascript:init();">
<div id="map"></div>
</body>
}
